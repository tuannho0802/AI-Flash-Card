name: Daily AI Enrichment

on:
  schedule:
    - cron: '0 0 * * *' # 00:00 UTC = 07:00 VN
  workflow_dispatch:
    inputs:
      custom_topics:
        description: 'Custom topics (comma-separated, optional)'
        required: false
        type: string

jobs:
  validate-config:
    name: üîç Pre-flight Validation
    runs-on: ubuntu-latest
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.SITE_URL }}" ]; then
            echo "ERROR: SITE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "ERROR: CRON_SECRET secret is not set"
            exit 1
          fi
          echo "All required secrets are configured"

  enrich:
    name: üöÄ AI Content Generation
    runs-on: ubuntu-latest
    needs: validate-config
    
    steps:
      - name: Select Random Topics
        id: select-topics
        run: |
          # Define topics with categories
          declare -A TOPIC_CATEGORIES=(
            ["Quantum Computing"]="C√¥ng Ngh·ªá"
            ["History of AI"]="C√¥ng Ngh·ªá"
            ["Ancient Civilizations"]="L·ªãch S·ª≠"
            ["Soft Skills for Managers"]="K·ªπ NƒÉng M·ªÅm"
            ["Modern Web Development"]="C√¥ng Ngh·ªá"
            ["Healthy Lifestyle Hacks"]="S·ª©c Kh·ªèe"
            ["Space Exploration"]="Khoa H·ªçc"
            ["Behavioral Economics"]="Kinh T·∫ø"
            ["Classical Literature"]="VƒÉn H·ªçc"
            ["Cybersecurity Basics"]="C√¥ng Ngh·ªá"
            ["Machine Learning Fundamentals"]="C√¥ng Ngh·ªá"
            ["Data Structures and Algorithms"]="C√¥ng Ngh·ªá"
            ["Philosophy of Mind"]="Tri·∫øt H·ªçc"
            ["Climate Change Science"]="Khoa H·ªçc"
            ["Personal Finance Management"]="T√†i Ch√≠nh"
          )
          
          # Get all topic names
          TOPICS=($(printf '%s\n' "${!TOPIC_CATEGORIES[@]}"))
          
          # Use custom topics if provided
          if [ -n "${{ github.event.inputs.custom_topics }}" ]; then
            IFS=',' read -ra CUSTOM_TOPICS <<< "${{ github.event.inputs.custom_topics }}"
            TOPICS=("${CUSTOM_TOPICS[@]}")
            echo "Using custom topics: ${TOPICS[*]}"
          fi
          
          # Pick 2 random topics
          SELECTED=$(printf '%s\n' "${TOPICS[@]}" | shuf -n 2)
          
          # Extract topic 1 and 2
          TOPIC1=$(echo "$SELECTED" | sed -n '1p')
          TOPIC2=$(echo "$SELECTED" | sed -n '2p')
          
          # Get categories (default to "Kh√°c" if not found)
          CATEGORY1="${TOPIC_CATEGORIES[$TOPIC1]:-Kh√°c}"
          CATEGORY2="${TOPIC_CATEGORIES[$TOPIC2]:-Kh√°c}"
          
          # Save to outputs using delimiter to avoid format issues
          echo "topic1<<EOF" >> $GITHUB_OUTPUT
          echo "$TOPIC1" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "category1<<EOF" >> $GITHUB_OUTPUT
          echo "$CATEGORY1" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "topic2<<EOF" >> $GITHUB_OUTPUT
          echo "$TOPIC2" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "category2<<EOF" >> $GITHUB_OUTPUT
          echo "$CATEGORY2" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "### Selected Topics for Today"
          echo "- $TOPIC1 ($CATEGORY1)"
          echo "- $TOPIC2 ($CATEGORY2)"

      - name: Process Topic 1
        id: topic1
        continue-on-error: true
        run: |
          TOPIC="${{ steps.select-topics.outputs.topic1 }}"
          CATEGORY="${{ steps.select-topics.outputs.category1 }}"
          SITE_URL="${{ secrets.SITE_URL }}"
          SITE_URL="${SITE_URL%/}"
          
          echo "Processing Topic 1: $TOPIC"
          echo "Category: $CATEGORY"
          
          # Construct JSON payload
          PAYLOAD=$(cat <<JSON
          {
            "topic": "$TOPIC",
            "category": "$CATEGORY",
            "count": 8,
            "isCron": true
          }
          JSON
          )
          
          echo "Payload:"
          echo "$PAYLOAD"
          
          # Make API request
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "$SITE_URL/api/generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "$PAYLOAD")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          HTTP_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "SUCCESS: Topic 1 processed"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "topic<<EOF" >> $GITHUB_OUTPUT
            echo "$TOPIC" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "FAILED: HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Cooldown Between Topics
        if: steps.topic1.outcome == 'success'
        run: |
          echo "Cooling down for 45 seconds..."
          sleep 45

      - name: Process Topic 2
        id: topic2
        continue-on-error: true
        run: |
          TOPIC="${{ steps.select-topics.outputs.topic2 }}"
          CATEGORY="${{ steps.select-topics.outputs.category2 }}"
          SITE_URL="${{ secrets.SITE_URL }}"
          SITE_URL="${SITE_URL%/}"
          
          echo "Processing Topic 2: $TOPIC"
          echo "Category: $CATEGORY"
          
          # Construct JSON payload
          PAYLOAD=$(cat <<JSON
          {
            "topic": "$TOPIC",
            "category": "$CATEGORY",
            "count": 8,
            "isCron": true
          }
          JSON
          )
          
          echo "Payload:"
          echo "$PAYLOAD"
          
          # Make API request
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "$SITE_URL/api/generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "$PAYLOAD")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          HTTP_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "SUCCESS: Topic 2 processed"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "topic<<EOF" >> $GITHUB_OUTPUT
            echo "$TOPIC" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "FAILED: HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate Report
        if: always()
        run: |
          echo "# Daily AI Enrichment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | Topic | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Topic 1
          TOPIC1_STATUS="${{ steps.topic1.outcome }}"
          TOPIC1_TOPIC="${{ steps.select-topics.outputs.topic1 }}"
          if [ "$TOPIC1_STATUS" = "success" ]; then
            echo "| 1 | $TOPIC1_TOPIC | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 1 | $TOPIC1_TOPIC | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Topic 2
          TOPIC2_STATUS="${{ steps.topic2.outcome }}"
          TOPIC2_TOPIC="${{ steps.select-topics.outputs.topic2 }}"
          if [ "$TOPIC2_STATUS" = "success" ]; then
            echo "| 2 | $TOPIC2_TOPIC | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 2 | $TOPIC2_TOPIC | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by Google Gemini AI*" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: üö® Failure Notification
    runs-on: ubuntu-latest
    needs: enrich
    if: failure()
    steps:
      - name: Report Failure
        run: |
          echo "Daily enrichment workflow encountered errors"
          echo "Check the workflow logs for details"