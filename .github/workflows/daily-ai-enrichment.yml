name: Daily AI Enrichment

on:
  schedule:
    - cron: '0 0 * * *' # 00:00 UTC = 07:00 VN
  workflow_dispatch:
    inputs:
      custom_topics:
        description: 'Custom topics (format: Topic1|Category1,Topic2|Category2)'
        required: false
        type: string

jobs:
  validate-config:
    name: üîç Pre-flight Validation
    runs-on: ubuntu-latest
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.SITE_URL }}" ]; then
            echo "ERROR: SITE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "ERROR: CRON_SECRET secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

  enrich:
    name: üöÄ AI Content Generation
    runs-on: ubuntu-latest
    needs: validate-config
    
    steps:
      - name: Select Random Topics
        id: select-topics
        run: |
          # Define topics with categories (format: Topic|Category)
          TOPICS=(
            "Quantum Computing|C√¥ng Ngh·ªá"
            "History of AI|C√¥ng Ngh·ªá"
            "Ancient Civilizations|L·ªãch S·ª≠"
            "Soft Skills for Managers|Qu·∫£n tr·ªã"
            "Modern Web Development|C√¥ng Ngh·ªá"
            "Healthy Lifestyle Hacks|S·ª©c Kh·ªèe"
            "Space Exploration|Khoa h·ªçc"
            "Behavioral Economics|Kinh t·∫ø"
            "Classical Literature|VƒÉn h·ªçc"
            "Cybersecurity Basics|C√¥ng Ngh·ªá"
            "Machine Learning Fundamentals|C√¥ng Ngh·ªá"
            "Data Structures and Algorithms|C√¥ng Ngh·ªá"
            "Philosophy of Mind|Tri·∫øt h·ªçc"
            "Climate Change Science|Khoa h·ªçc"
            "Personal Finance Management|T√†i ch√≠nh"
          )
          
          # Use custom topics if provided
          if [ -n "${{ github.event.inputs.custom_topics }}" ]; then
            IFS=',' read -ra TOPICS <<< "${{ github.event.inputs.custom_topics }}"
            echo "üìù Using custom topics: ${TOPICS[*]}"
          fi
          
          # Pick 2 random topics using shuf
          SELECTED=$(printf '%s\n' "${TOPICS[@]}" | shuf -n 2)
          
          # Extract Topic 1
          LINE1=$(echo "$SELECTED" | sed -n '1p')
          TOPIC1=$(echo "$LINE1" | cut -d'|' -f1)
          CATEGORY1=$(echo "$LINE1" | cut -d'|' -f2)
          
          # Extract Topic 2
          LINE2=$(echo "$SELECTED" | sed -n '2p')
          TOPIC2=$(echo "$LINE2" | cut -d'|' -f1)
          CATEGORY2=$(echo "$LINE2" | cut -d'|' -f2)
          
          # Save to outputs using heredoc
          cat >> $GITHUB_OUTPUT <<EOF
          topic1<<TOPIC1_EOF
          $TOPIC1
          TOPIC1_EOF
          category1<<CAT1_EOF
          $CATEGORY1
          CAT1_EOF
          topic2<<TOPIC2_EOF
          $TOPIC2
          TOPIC2_EOF
          category2<<CAT2_EOF
          $CATEGORY2
          CAT2_EOF
          EOF
          
          echo "### üìö Selected Topics for Today"
          echo "- **$TOPIC1** ($CATEGORY1)"
          echo "- **$TOPIC2** ($CATEGORY2)"

      - name: Process Topic 1
        id: topic1
        continue-on-error: true
        run: |
          TOPIC="${{ steps.select-topics.outputs.topic1 }}"
          CATEGORY="${{ steps.select-topics.outputs.category1 }}"
          SITE_URL="${{ secrets.SITE_URL }}"
          SITE_URL="${SITE_URL%/}"
          
          echo "üéØ Processing Topic 1: $TOPIC"
          echo "üìÇ Category: $CATEGORY"
          
          # Construct JSON payload using jq for safe escaping
          PAYLOAD=$(jq -n \
            --arg topic "$TOPIC" \
            --arg category "$CATEGORY" \
            --argjson count 8 \
            --argjson isCron true \
            '{topic: $topic, category: $category, count: $count, isCron: $isCron}')
          
          echo "üì§ Payload: $PAYLOAD"
          
          # Make API request
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "$SITE_URL/api/generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "User-Agent: GitHub-Actions-Daily-Enrichment/1.0" \
            -d "$PAYLOAD")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          HTTP_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "üì• HTTP Status: $HTTP_CODE"
          echo "üì• Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Topic 1 processed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå FAILED: HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Cooldown Between Topics
        if: steps.topic1.outcome == 'success'
        run: |
          echo "‚è∏Ô∏è Cooling down for 45 seconds to respect rate limits..."
          sleep 45

      - name: Process Topic 2
        id: topic2
        continue-on-error: true
        run: |
          TOPIC="${{ steps.select-topics.outputs.topic2 }}"
          CATEGORY="${{ steps.select-topics.outputs.category2 }}"
          SITE_URL="${{ secrets.SITE_URL }}"
          SITE_URL="${SITE_URL%/}"
          
          echo "üéØ Processing Topic 2: $TOPIC"
          echo "üìÇ Category: $CATEGORY"
          
          # Construct JSON payload using jq for safe escaping
          PAYLOAD=$(jq -n \
            --arg topic "$TOPIC" \
            --arg category "$CATEGORY" \
            --argjson count 8 \
            --argjson isCron true \
            '{topic: $topic, category: $category, count: $count, isCron: $isCron}')
          
          echo "üì§ Payload: $PAYLOAD"
          
          # Make API request
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "$SITE_URL/api/generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "User-Agent: GitHub-Actions-Daily-Enrichment/1.0" \
            -d "$PAYLOAD")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          HTTP_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "üì• HTTP Status: $HTTP_CODE"
          echo "üì• Response: $HTTP_BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Topic 2 processed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå FAILED: HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate Report
        if: always()
        run: |
          {
            echo "# ü§ñ Daily AI Enrichment Summary"
            echo ""
            echo "**Execution Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "## üìä Processing Results"
            echo ""
            echo "| # | Topic | Category | Status |"
            echo "|---|-------|----------|--------|"
            
            # Topic 1
            TOPIC1="${{ steps.select-topics.outputs.topic1 }}"
            CAT1="${{ steps.select-topics.outputs.category1 }}"
            STATUS1="${{ steps.topic1.outcome }}"
            if [ "$STATUS1" = "success" ]; then
              echo "| 1 | $TOPIC1 | $CAT1 | ‚úÖ Success |"
            else
              echo "| 1 | $TOPIC1 | $CAT1 | ‚ùå Failed |"
            fi
            
            # Topic 2
            TOPIC2="${{ steps.select-topics.outputs.topic2 }}"
            CAT2="${{ steps.select-topics.outputs.category2 }}"
            STATUS2="${{ steps.topic2.outcome }}"
            if [ "$STATUS2" = "success" ]; then
              echo "| 2 | $TOPIC2 | $CAT2 | ‚úÖ Success |"
            else
              echo "| 2 | $TOPIC2 | $CAT2 | ‚ùå Failed |"
            fi
            
            echo ""
            echo "---"
            echo "*Powered by Google Gemini AI ‚Ä¢ Next.js 15*"
          } >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: üö® Failure Notification
    runs-on: ubuntu-latest
    needs: enrich
    if: failure()
    steps:
      - name: Report Failure
        run: |
          {
            echo "## ‚ö†Ô∏è Daily Enrichment Failed"
            echo ""
            echo "The workflow encountered errors. Common causes:"
            echo "- 429 Rate Limit: Gemini API quota exhausted"
            echo "- 401/403 Auth Error: Check CRON_SECRET"
            echo "- 500 Server Error: Check backend logs"
          } >> $GITHUB_STEP_SUMMARY